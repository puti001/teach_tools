<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Puti-Aiå­¸ç”ŸæœŸæœ«è©•èªç”¢ç”Ÿå™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
        }
        .trait-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .trait-column {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        .trait-btn {
            margin: 5px;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: normal;
            opacity: 0.5;
            pointer-events: none;
        }
        .trait-btn:hover {
            background-color: #ffe69c;
        }
        .trait-btn.selected {
            background-color: #ffd43b;
            font-weight: bold;
            font-size: 16px;
            transform: scale(1.05);
        }
        .trait-btn.enabled {
            opacity: 1;
            pointer-events: auto;
        }
        #selectedTraits .trait-btn {
            background-color: #ffd43b;
            font-weight: bold;
            font-size: 16px;
        }
        #selectedTraits {
            min-height: 100px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #previewArea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        .action-btn:hover {
            background-color: #0056b3;
        }
        .api-key-section {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .api-key-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        
        .students-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .custom-traits-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .download-btn {
            margin-left: 10px;
        }
        
        #downloadOptions {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        
        #downloadOptions button {
            display: block;
            width: 100%;
            padding: 5px;
            margin: 5px 0;
            border: none;
            background: none;
            cursor: pointer;
        }
        
        #downloadOptions button:hover {
            background-color: #f0f0f0;
        }
        .student-buttons {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .student-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
        }

        .student-btn.selected {
            background-color: #28a745;
            color: white;
            font-weight: bold;
        }

        .student-btn.has-comment {
            border: 2px solid #28a745;
        }

        .clear-btn {
            background-color: #dc3545;
            margin-top: 10px;
        }

        .clear-btn:hover {
            background-color: #c82333;
        }

        .custom-trait-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .custom-trait-container .custom-traits-input {
            flex: 1;
            margin-bottom: 0;
        }

        #selectedTraits {
            scroll-margin-top: 20px;
        }

        .traits-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .traits-actions {
            display: flex;
            gap: 10px;
        }

        .traits-actions .action-btn {
            padding: 5px 10px;
            font-size: 14px;
        }

        .style-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .style-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            background-color: #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .style-btn:hover {
            background-color: #ffe69c;
        }

        .style-btn.selected {
            background-color: #ffd43b;
            font-weight: bold;
            transform: scale(1.05);
        }

        .style-btn .tooltip {
            visibility: hidden;
            position: absolute;
            background-color: #333;
            color: white;
            padding: 10px;
            border-radius: 4px;
            width: 200px;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .style-btn:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .word-limit-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .word-limit-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            background-color: #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .word-limit-btn:hover {
            background-color: #ffe69c;
        }

        .word-limit-btn.selected {
            background-color: #ffd43b;
            font-weight: bold;
            transform: scale(1.05);
        }

        .notice-section {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .notice-section h3 {
            color: #856404;
            margin-top: 0;
        }

        .notice-content {
            color: #666;
        }

        .notice-content ol {
            padding-left: 20px;
        }

        .notice-content ul {
            padding-left: 20px;
            margin: 5px 0;
        }

        .notice-content a {
            color: #007bff;
            text-decoration: none;
        }

        .notice-content a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Puti-Aiå­¸ç”ŸæœŸæœ«è©•èªç”¢ç”Ÿå™¨</h1>
        
        <!-- API Key å€åŸŸ -->
        <div class="section notice-section">
            <h3>ğŸ”” é‡è¦æé†’</h3>
            <div class="notice-content">
                <p><strong>ç„¡æ³•ç”Ÿæˆè©•èªï¼Ÿè«‹æª¢æŸ¥ï¼š</strong></p>
                <ol>
                    <li>API Key æ˜¯å¦æ­£ç¢ºï¼Ÿ
                        <ul>
                            <li>è«‹åˆ° <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a> ç”³è«‹</li>
                            <li>ç¢ºèªå®Œæ•´è¤‡è£½ï¼Œä¸è¦æœ‰ç©ºæ ¼</li>
                            <li>éœ€è¦å•Ÿç”¨ Gemini API æœå‹™</li>
                        </ul>
                    </li>
                    <li>ä½¿ç”¨æ¬¡æ•¸æ˜¯å¦è¶…éé™åˆ¶ï¼Ÿ
                        <ul>
                            <li>æ¯å€‹ API Key æ¯åˆ†é˜æœ‰æ¬¡æ•¸é™åˆ¶</li>
                            <li>å»ºè­°ç­‰å¾…ä¸€ä¸‹å†è©¦</li>
                            <li>æˆ–ç”³è«‹æ–°çš„ API Key</li>
                        </ul>
                    </li>
                    <li>ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸ï¼Ÿ
                        <ul>
                            <li>ç¢ºèªç¶²è·¯ç©©å®š</li>
                            <li>å¯èƒ½éœ€è¦ç§‘å­¸ä¸Šç¶²</li>
                        </ul>
                    </li>
                    <li>ç€è¦½å™¨å’Œç³»çµ±å»ºè­°ï¼š
                        <ul>
                            <li>å»ºè­°ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨</li>
                            <li>Safari ç”¨æˆ¶å¯èƒ½éœ€è¦å…è¨±è·¨åŸŸè«‹æ±‚</li>
                            <li>è«‹ç¢ºä¿ç€è¦½å™¨å·²æ›´æ–°è‡³æœ€æ–°ç‰ˆæœ¬</li>
                            <li>æš«æ™‚åœç”¨å¯èƒ½é€ æˆå¹²æ“¾çš„æ“´å……åŠŸèƒ½</li>
                            <li>å»ºè­°ä½¿ç”¨é›»è…¦ç‰ˆç€è¦½å™¨æ“ä½œ</li>
                        </ul>
                    </li>
                </ol>
                <p><strong>ğŸ’¡ æœ€ä½³ä½¿ç”¨å»ºè­°ï¼š</strong></p>
                <ul>
                    <li>ä½¿ç”¨ Windows/macOS é›»è…¦</li>
                    <li>é¸ç”¨ Chrome æˆ– Edge æœ€æ–°ç‰ˆæœ¬</li>
                    <li>ç¢ºä¿ç¶²è·¯ç©©å®šä¸”å¯æ­£å¸¸è¨ªå• Google æœå‹™</li>
                    <li>å»ºè­°æº–å‚™å¤šå€‹ API Key ä»¥å‚™ä¸æ™‚ä¹‹éœ€</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <div class="api-key-section">
                <input type="password" id="apiKeyInput" class="api-key-input" 
                       placeholder="è«‹è¼¸å…¥ Gemini API Key">
                <button class="action-btn" onclick="saveApiKey()">å„²å­˜</button>
                <button class="action-btn" onclick="toggleApiKey()">é¡¯ç¤º/éš±è—</button>
                <button class="action-btn" onclick="resetApiKey()">é‡è¨­</button>
            </div>
        </div>

        <!-- å­¸ç”Ÿæ¸…å–®è¼¸å…¥å€ -->
        <div class="section">
            <h3>å­¸ç”Ÿæ¸…å–®ï¼ˆä¸€è¡Œä¸€å€‹å­¸ç”Ÿï¼Œæ ¼å¼ï¼šåº§è™Ÿ.å§“åï¼‰</h3>
            <textarea id="studentsInput" class="students-input" 
                      placeholder="ä¾‹å¦‚ï¼š&#13;&#10;1.é»ƒæ¨‚æ¨‚&#13;&#10;2.å¼µå°æ˜"></textarea>
            <button class="action-btn" onclick="generateStudentButtons()">ç”¢ç”Ÿå­¸ç”ŸæŒ‰éˆ•</button>
            <div id="studentButtons" class="student-buttons"></div>
        </div>

        <!-- ç‰¹è³ªé¸æ“‡å€ -->
        <div class="section">
            <div class="traits-header">
                <h3>ç‰¹è³ªé¸æ“‡ï¼š</h3>
                <button class="action-btn" onclick="resetTraitButtons()">é‡ç½®ç‰¹è³ª</button>
            </div>
            <div class="trait-section" id="trait-section">
                <!-- ç‰¹è³ªæŒ‰éˆ•å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ä½¿ç”¨è€…å®¢è£½ç‰¹è³ªè¼¸å…¥å€ -->
        <div class="section">
            <h3>æ–°å¢è‡ªè¨‚ç‰¹è³ªï¼ˆæœ€å¤š10å€‹ï¼‰</h3>
            <div class="custom-trait-container">
                <input type="text" id="customTraitInput" class="custom-traits-input" 
                       placeholder="è¼¸å…¥è‡ªè¨‚ç‰¹è³ªå¾ŒæŒ‰Enter">
                <button class="action-btn" onclick="clearCustomTraits()">æ¸…é™¤è‡ªè¨‚ç‰¹è³ª</button>
            </div>
        </div>

        <!-- å·²é¸æ“‡çš„ç‰¹è³ªå€ -->
        <div class="section">
            <div class="traits-header">
                <h3>å·²é¸æ“‡çš„ç‰¹è³ªï¼š</h3>
                <div class="traits-actions">
                    <button class="action-btn" onclick="clearSelectedTraits()">æ¸…ç©ºå·²é¸ç‰¹è³ª</button>
                </div>
            </div>
            <div id="selectedTraits"></div>
        </div>

        <!-- è©•èªé¢¨æ ¼é¸æ“‡å€ -->
        <div class="section">
            <div class="traits-header">
                <h3>è©•èªé¢¨æ ¼ï¼ˆæœ€å¤šé¸æ“‡å…©ç¨®ï¼‰ï¼š</h3>
                <button class="action-btn" onclick="resetStyleButtons()">é‡ç½®é¢¨æ ¼</button>
            </div>
            <div id="styleButtons" class="style-buttons"></div>
        </div>

        <!-- è©•èªå­—æ•¸é™åˆ¶ -->
        <div class="section">
            <div class="traits-header">
                <h3>è©•èªå­—æ•¸é™åˆ¶ï¼š</h3>
            </div>
            <div id="wordLimitButtons" class="word-limit-buttons">
                <button class="word-limit-btn" onclick="setWordLimit(300)">300å­—</button>
                <button class="word-limit-btn" onclick="setWordLimit(200)">200å­—</button>
                <button class="word-limit-btn selected" onclick="setWordLimit(150)">150å­—</button>
                <button class="word-limit-btn" onclick="setWordLimit(100)">100å­—</button>
                <button class="word-limit-btn" onclick="setWordLimit(50)">50å­—</button>
                <button class="word-limit-btn" onclick="setWordLimit(16)">16å­—</button>
            </div>
        </div>

        <!-- ç”Ÿæˆè©•èªæŒ‰éˆ• -->
        <button class="action-btn" onclick="generateComment()">ç”Ÿæˆè©•èª</button>

        <!-- è©•èªé è¦½å€ -->
        <div class="section">
            <h3>è©•èªé è¦½ï¼š</h3>
            <textarea id="previewArea"></textarea>
            <button class="action-btn clear-btn" onclick="clearCommentHistory()">æ¸…é™¤è¨˜éŒ„</button>
        </div>

        <!-- ä¸‹è¼‰æŒ‰éˆ• -->
        <div class="section">
            <button class="action-btn" onclick="showDownloadOptions()">ä¸‹è¼‰</button>
            <div id="downloadOptions">
                <button onclick="downloadFile('txt')">ä¸‹è¼‰ TXT</button>
                <button onclick="downloadFile('csv')">ä¸‹è¼‰ CSV</button>
            </div>
        </div>
    </div>

    <script>
        // ç‰¹è³ªè³‡æ–™
        const traitData = {
            headers: ['è³‡è³ªèˆ‡æ…‹åº¦', 'å€‹æ€§èˆ‡å“å¾·', 'åœ˜é«”èˆ‡äººéš›', 'å°ˆé•·èˆ‡æ‰è—', 'ä½¿ç”¨è€…å®¢è£½'],
            traits: {
                è³‡è³ªèˆ‡æ…‹åº¦: ['è°ç©éˆæ´»', 'ç†è§£åŠ›å¼·', 'é ˜æ‚Ÿå¿«é€Ÿ', 'èªçœŸå°ˆæ³¨', 'å‹¤å‹‰å¥½å­¸', 
                           'ä¸»å‹•æ±‚çŸ¥', 'å–„æ–¼æ€è€ƒ', 'èˆ‰ä¸€åä¸‰', 'è§€å¯ŸåŠ›ä½³', 'è¡¨é”æ¸…æ™°', 
                           'å–„æ–¼æºé€š', 'å‹‡æ–¼ç™¼è¡¨', 'ä¸å¤ èªçœŸ', 'æ¬ ç¼ºå°ˆæ³¨', 'æ€ å¿½å­¸æ¥­', 
                           'ç†è§£è¼ƒæ…¢', 'éœ€å¤šç·´ç¿’', 'æœ‰å¾…åŠ å¼·', 'é²äº¤ä½œæ¥­'],
                å€‹æ€§èˆ‡å“å¾·: ['æ€§æ ¼æº«å’Œ', 'æº«é †æ–‡éœ', 'èª å¯¦', 'å®ˆè¦çŸ©', 'æœ‰ç¦®è²Œ', 
                           'é–‹æœ—æ´»æ½‘', 'æ¨‚è§€', 'è² è²¬ç›¡è·', 'åšäº‹èªçœŸ', 'å®ˆåˆ†è² è²¬', 
                           'æ€§æ ¼å…§å‘', 'ä¸å–„äº¤éš›', 'ç¾æ€¯è†½å°', 'ä¸å¤ è‡ªå¾‹', 'åšäº‹ç²—å¿ƒ'],
                åœ˜é«”èˆ‡äººéš›: ['å¾…äººå’Œå–„', 'äººç·£è‰¯å¥½', 'å–„è§£äººæ„', 'æ¨‚æ–¼åŠ©äºº', 'ç†±å¿ƒæœå‹™', 
                           'å…·é ˜å°åŠ›', 'å‹æ„›åŒå­¸', 'é¡˜æ„åˆ†äº«', 'æ¨‚æ–¼åˆä½œ', 'ä¸å¤ªåˆç¾¤', 
                           'è¼ƒå°‘äº’å‹•', 'ä¸å–„åˆä½œ', 'è¼ƒå°‘åƒèˆ‡'],
                å°ˆé•·èˆ‡æ‰è—: ['èªæ–‡èƒ½åŠ›å¼·', 'å¯«ä½œè¡¨é”ä½³', 'æ•¸ç†èƒ½åŠ›ä½³', 'é‚è¼¯æ€ç¶­å¼·', 
                           'è¨ˆç®—èƒ½åŠ›å¥½', 'è¡¨æ¼”æ‰èƒ½å„ª', 'ç¾è¡“å¤©åˆ†ä½³', 'éŸ³æ¨‚æ„Ÿä½³', 
                           'é‹å‹•èƒ½åŠ›å¼·', 'é«”èƒ½æ´»å‹•å¥½', 'å‹•ä½œå”èª¿ä½³', 'å‰µæ„æ€ç¶­ä½³', 
                           'æƒ³åƒåŠ›è±å¯Œ', 'å‰µæ„é»å­å¤š'],
                ä½¿ç”¨è€…å®¢è£½: []
            }
        };

        // è©•èªé¢¨æ ¼è³‡æ–™
        const styleData = [
            {
                name: 'å£èªäººæ€§åŒ–',
                description: 'ä»¥è‡ªç„¶è¦ªåˆ‡çš„èªæ°£è¡¨é”ï¼Œè®“å­¸ç”Ÿæ„Ÿåˆ°è¦ªè¿‘èˆ‡é—œæ‡·ã€‚',
                example: 'ä½ é€™å­¸æœŸçš„è¡¨ç¾å¾ˆæ£’ï¼å¶çˆ¾æœƒå°å°åˆ†å¿ƒï¼Œä½†é€²æ­¥è¶…ç´šæ˜é¡¯ï¼Œç¹¼çºŒä¿æŒé€™å€‹å‹¢é ­å“¦ï¼'
            },
            {
                name: 'é¼“å‹µå‹',
                description: 'è‘—é‡æ–¼è‚¯å®šèˆ‡æ¿€å‹µå­¸ç”Ÿæˆé•·ã€‚',
                example: 'ä½ åœ¨é€™å­¸æœŸè¡¨ç¾å‡ºç©©æ­¥æˆé•·ï¼ŒæŒçºŒåŠªåŠ›ä¸€å®šæœƒå–å¾—æ›´å¤§é€²æ­¥ï¼ŒåŠ æ²¹ï¼'
            },
            {
                name: 'å¹½é»˜',
                description: 'å¢åŠ è¼•é¬†æ„Ÿï¼Œé©åˆèæ´½çš„å¸«ç”Ÿé—œä¿‚ã€‚',
                example: 'ä½ çš„å¹½é»˜ç¸½èƒ½è®“ç­ä¸Šå……æ»¿ç¬‘è²ï¼Œä½†è¨˜å¾—ä½œæ¥­ä¹Ÿè¦åƒç¬‘è©±ä¸€æ¨£ç²¾å½©ï¼'
            },
            {
                name: 'æº«é¦¨',
                description: 'è‘—é‡æ–¼æƒ…æ„Ÿäº¤æµï¼Œé©åˆé—œå¿ƒå­¸ç”Ÿèº«å¿ƒç™¼å±•ã€‚',
                example: 'çœ‹åˆ°ä½ çš„è‡ªä¿¡èˆ‡ç¬‘å®¹é€æ¼¸ç¶»æ”¾ï¼Œè€å¸«æ·±æ„Ÿæ¬£æ…°ï¼Œç¹¼çºŒä¿æŒé€™ä»½ç†±æƒ…ï¼'
            },
            {
                name: 'åˆ†æå‹',
                description: 'è©³ç´°æŒ‡å‡ºå­¸ç”Ÿå„ªå‹¢èˆ‡æ”¹é€²æ–¹å‘ã€‚',
                example: 'ä½ çš„æ•¸ç†é‚è¼¯è¡¨ç¾çªå‡ºï¼Œä½†åœ¨èªæ–‡ç†è§£æ–¹é¢å¯å¤šåŠ å¼·ï¼ŒæœŸå¾…ä½ åœ¨ä¸‹å­¸æœŸå–å¾—æ›´å…¨é¢çš„ç™¼å±•ã€‚'
            },
            {
                name: 'è©©æ„',
                description: 'ç”¨èªå„ªç¾ï¼Œé©åˆé‡è¦–æ–‡å­¸æ°£æ¯çš„å¸«ç”Ÿã€‚',
                example: 'ä½ å°±åƒæ™¨æ›¦ä¸­çš„éœ²ç ï¼Œé–ƒè€€è‘—ç´”çœŸèˆ‡å¸Œæœ›ï¼Œè®“å­¸ç¿’æ—…ç¨‹å……æ»¿å…‰å½©ã€‚'
            },
            {
                name: 'å€‹æ€§åŒ–',
                description: 'æ ¹æ“šå­¸ç”Ÿçš„å…·é«”ç‰¹è³ªé‡èº«æ‰“é€ ï¼Œå‡¸é¡¯å€‹åˆ¥ç‰¹è‰²ã€‚',
                example: 'ä½ ç¸½æ˜¯ç”¨å‰µæ„èˆ‡ç†±æƒ…æ„ŸæŸ“å¤§å®¶ï¼Œæ˜¯ç­ä¸Šçš„éˆé­‚äººç‰©ï¼Œè€å¸«ç‚ºä½ æ„Ÿåˆ°é©•å‚²ï¼'
            },
            {
                name: 'ç›®æ¨™å°å‘',
                description: 'æ˜ç¢ºæŒ‡å‡ºæœªä¾†æ–¹å‘èˆ‡å»ºè­°ã€‚',
                example: 'ç¹¼çºŒä¿æŒå°ˆæ³¨åŠ›èˆ‡å …æŒä¸æ‡ˆçš„ç²¾ç¥ï¼Œé€™å°‡å¹«åŠ©ä½ åœ¨æœªä¾†çš„æŒ‘æˆ°ä¸­å–å¾—æˆåŠŸï¼'
            },
            {
                name: 'æ•…äº‹å‹',
                description: 'ä»¥å°æ•…äº‹æˆ–æƒ…å¢ƒæè¿°å­¸ç”Ÿè¡¨ç¾ï¼Œå¢å¼·è¶£å‘³æ€§ã€‚',
                example: 'é‚„è¨˜å¾—ä½ ç¬¬ä¸€æ¬¡å‹‡æ•¢èˆ‰æ‰‹å›ç­”å•é¡Œçš„æ™‚åˆ»å—ï¼Ÿé‚£ä»½è‡ªä¿¡å€¼å¾—ä½ ç¹¼çºŒä¿æŒä¸¦ç™¼æšå…‰å¤§ï¼'
            },
            {
                name: 'åå…­ç®´è¨€',
                description: 'æ¡ç”¨å››å­—è©èªçµ„æˆçš„è©•èªï¼Œç°¡æ½”è€Œå¯Œå«å“²ç†ã€‚',
                example: 'å‹¤å¥®åˆ»è‹¦ï¼ŒæŒä¹‹ä»¥æ†ï¼›è™›å¿ƒå­¸ç¿’ï¼Œå‹‡æ–¼æŒ‘æˆ°ã€‚'
            }
        ];

        let selectedStyles = new Set();

        // åˆå§‹åŒ–é é¢
        window.onload = function() {
            loadApiKey();
            loadStudentList();
            loadCustomTraits();
            updateTraits();
            setupCustomTraitInput();
            initializeStyleButtons();
        }

        let selectedTraits = new Set();
        let customTraitCount = 0;
        let selectedStudent = null;
        let commentHistory = {};
        let customTraits = [];

        // API Key ç›¸é—œå‡½æ•¸
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value;
            if (apiKey) {
                localStorage.setItem('geminiApiKey', apiKey);
                alert('API Key å·²å„²å­˜ï¼');
            } else {
                alert('è«‹è¼¸å…¥ API Keyï¼');
            }
        }

        function loadApiKey() {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (apiKey) {
                document.getElementById('apiKeyInput').value = apiKey;
            }
        }

        function toggleApiKey() {
            const input = document.getElementById('apiKeyInput');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function resetApiKey() {
            localStorage.removeItem('geminiApiKey');
            document.getElementById('apiKeyInput').value = '';
            alert('API Key å·²é‡è¨­ï¼');
        }

        // ç‰¹è³ªç›¸é—œå‡½æ•¸
        function updateTraits() {
            const traitSection = document.getElementById('trait-section');
            traitSection.innerHTML = '';
            
            traitData.headers.forEach(header => {
                const column = document.createElement('div');
                column.className = 'trait-column';
                
                const title = document.createElement('h3');
                title.textContent = header;
                column.appendChild(title);
                
                const traitsContainer = document.createElement('div');
                traitData.traits[header].forEach(trait => {
                    const button = document.createElement('button');
                    button.className = 'trait-btn';
                    button.textContent = trait;
                    if (selectedTraits.has(trait)) {
                        button.classList.add('selected');
                    }
                    button.onclick = () => addTrait(trait, button);
                    traitsContainer.appendChild(button);
                });
                
                column.appendChild(traitsContainer);
                traitSection.appendChild(column);
            });
        }

        function setupCustomTraitInput() {
            const input = document.getElementById('customTraitInput');
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const trait = input.value.trim();
                    if (trait) {
                        if (!customTraits.includes(trait)) {
                            if (customTraits.length >= 10) {
                                customTraits.shift();
                            }
                            customTraits.push(trait);
                            traitData.traits['ä½¿ç”¨è€…å®¢è£½'] = customTraits;
                            customTraitCount = customTraits.length;
                            saveCustomTraits();
                            updateTraits();
                            input.value = '';
                        }
                    }
                }
            });
        }

        function addTrait(trait, button) {
            if (!selectedStudent) {
                alert('è«‹å…ˆé¸æ“‡å­¸ç”Ÿï¼');
                return;
            }
            
            if (selectedTraits.has(trait)) {
                // å¦‚æœç‰¹è³ªå·²è¢«é¸ä¸­ï¼Œå‰‡ç§»é™¤å®ƒ
                selectedTraits.delete(trait);
                button.classList.remove('selected');
            } else {
                // å¦‚æœç‰¹è³ªæœªè¢«é¸ä¸­ï¼Œå‰‡æ·»åŠ å®ƒ
                selectedTraits.add(trait);
                button.classList.add('selected');
            }
            updateSelectedTraitsDisplay();
        }

        function updateSelectedTraitsDisplay() {
            const container = document.getElementById('selectedTraits');
            container.innerHTML = '';
            selectedTraits.forEach(trait => {
                const span = document.createElement('span');
                span.className = 'trait-btn';
                span.textContent = trait;
                span.onclick = () => removeTrait(trait);
                container.appendChild(span);
            });
        }

        function removeTrait(trait) {
            selectedTraits.delete(trait);
            // åŒæ™‚æ›´æ–°åŸå§‹ç‰¹è³ªæŒ‰éˆ•çš„ç‹€æ…‹
            const traitButtons = document.querySelectorAll('.trait-btn');
            traitButtons.forEach(button => {
                if (button.textContent === trait) {
                    button.classList.remove('selected');
                }
            });
            updateSelectedTraitsDisplay();
        }

        // è©•èªç”Ÿæˆç›¸é—œå‡½æ•¸
        async function generateComment() {
            if (!selectedStudent) {
                alert('è«‹å…ˆé¸æ“‡å­¸ç”Ÿï¼');
                return;
            }
            
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                alert('è«‹å…ˆè¨­å®š API Keyï¼');
                return;
            }

            if (selectedTraits.size === 0) {
                alert('è«‹å…ˆé¸æ“‡å­¸ç”Ÿç‰¹è³ªï¼');
                return;
            }

            const traits = Array.from(selectedTraits).join('ã€');
            const styles = Array.from(selectedStyles).join('ã€');
            const stylePrompt = styles ? `ï¼Œè«‹ä½¿ç”¨${styles}é¢¨æ ¼` : '';
            
            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + apiKey, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `è«‹æ ¹æ“šä»¥ä¸‹å­¸ç”Ÿç‰¹è³ªï¼Œç‚ºå­¸ç”Ÿã€Œ${selectedStudent}ã€ç”Ÿæˆä¸€æ®µ${currentWordLimit}å­—çš„æœŸæœ«è©•èª${stylePrompt}ã€‚è©•èªè¦æœ‰å‰µæ„ï¼Œä½¿ç”¨æ­£å‘é¼“å‹µçš„èªï¿½ï¿½å’Œæº«æš–è¦ªåˆ‡çš„å£æ°£ã€‚è«‹ä½¿ç”¨ç¬¬äºŒäººç¨±ã€Œä½ ã€ä¾†ç¨±å‘¼å­¸ç”Ÿï¼Œä¸è¦ç”¨ç¬¬ä¸‰äººç¨±ã€‚ç‰¹è³ªï¼š${traits}`
                            }]
                        }]
                    })
                });

                // åŠ å…¥ HTTP ç‹€æ…‹ç¢¼æª¢æŸ¥
                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('API Key ç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹ç¢ºèªæ˜¯å¦æ­£ç¢ºè¤‡è£½æˆ–é‡æ–°ç”³è«‹');
                    } else if (response.status === 429) {
                        throw new Error('å·²è¶…é API ä½¿ç”¨é™åˆ¶ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–ç”³è«‹æ–°çš„ API Key');
                    } else {
                        throw new Error(`API è«‹æ±‚å¤±æ•— (ç‹€æ…‹ç¢¼: ${response.status})`);
                    }
                }

                const data = await response.json();
                if (!data.candidates || !data.candidates[0]?.content?.parts[0]?.text) {
                    throw new Error('AI å›æ‡‰æ ¼å¼ç•°å¸¸ï¼Œè«‹é‡æ–°ç”Ÿæˆ');
                }
                
                const comment = data.candidates[0].content.parts[0].text;
                document.getElementById('previewArea').value = comment;
                commentHistory[selectedStudent] = comment;
                updateStudentButtonStatus();
            } catch (error) {
                // æ›´å‹å–„çš„éŒ¯èª¤æç¤º
                let errorMessage = 'ç”Ÿæˆè©•èªæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š\n\n';
                if (error.message.includes('API Key')) {
                    errorMessage += '1. è«‹ç¢ºèª API Key æ˜¯å¦æ­£ç¢º\n';
                    errorMessage += '2. å»ºè­°é‡æ–°ç”³è«‹ API Key\n';
                    errorMessage += '3. ç¢ºèª API Key å·²å•Ÿç”¨ Gemini API æœå‹™';
                } else if (error.message.includes('é™åˆ¶')) {
                    errorMessage += '1. æ¯å€‹ API Key æœ‰ä½¿ç”¨æ¬¡æ•¸é™åˆ¶\n';
                    errorMessage += '2. å»ºè­°ç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œå†è©¦\n';
                    errorMessage += '3. æˆ–ç”³è«‹æ–°çš„ API Key';
                } else {
                    errorMessage += error.message;
                }
                alert(errorMessage);
            }
        }

        // ä¸‹è¼‰ç›¸é—œå‡½æ•¸
        function showDownloadOptions() {
            const options = document.getElementById('downloadOptions');
            options.style.display = options.style.display === 'none' ? 'block' : 'none';
        }

        function downloadFile(type) {
            const studentsText = document.getElementById('studentsInput').value;
            
            if (!studentsText) {
                alert('è«‹å…ˆè¼¸å…¥å­¸ç”Ÿè³‡æ–™ï¼');
                return;
            }

            const students = studentsText.split('\n').filter(line => line.trim());
            let content = '';
            
            if (type === 'txt') {
                content = students.map(student => 
                    `${student}\n${commentHistory[student] || 'å°šæœªç”¢ç”Ÿè©•èª'}\n\n`
                ).join('');
                downloadTextFile(content, 'student_comments.txt');
            } else if (type === 'csv') {
                content = 'åº§è™Ÿ,å§“å,è©•èª\n';
                content += students.map(student => {
                    const [number, name] = student.split('.');
                    return `${number},${name},"${commentHistory[student] || ''}"`;
                }).join('\n');
                downloadTextFile(content, 'student_comments.csv');
            }
        }

        function downloadTextFile(content, filename) {
            // åŠ å…¥ BOM æ¨™è¨˜ï¼Œè§£æ±º CSV ä¸­æ–‡äº‚ç¢¼å•é¡Œ
            const bom = '\uFEFF';
            const blob = new Blob([bom + content], { 
                type: filename.endsWith('.csv') 
                    ? 'text/csv;charset=utf-8' 
                    : 'text/plain;charset=utf-8' 
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function generateStudentButtons() {
            const studentsText = document.getElementById('studentsInput').value;
            const studentButtons = document.getElementById('studentButtons');
            studentButtons.innerHTML = '';
            
            if (!studentsText.trim()) {
                alert('è«‹å…ˆè¼¸å…¥å­¸ç”Ÿè³‡æ–™ï¼');
                return;
            }
            
            saveStudentList();
            
            const students = studentsText.split('\n').filter(line => line.trim());
            
            students.forEach(student => {
                const button = document.createElement('button');
                button.className = 'student-btn';
                button.textContent = student;
                if (commentHistory[student]) {
                    button.classList.add('has-comment');
                }
                button.onclick = () => selectStudent(student, button);
                studentButtons.appendChild(button);
            });
            
            // é‡ç½®é¸æ“‡çš„å­¸ç”Ÿ
            selectedStudent = null;
            // æ¸…ç©ºå·²é¸ç‰¹è³ª
            selectedTraits.clear();
            updateSelectedTraitsDisplay();
            // ç¦ç”¨æ‰€æœ‰ç‰¹è³ªæŒ‰éˆ•
            disableTraitButtons();
        }

        function selectStudent(student, button) {
            // ç§»é™¤å…¶ä»–å­¸ç”ŸæŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
            const allStudentButtons = document.querySelectorAll('.student-btn');
            allStudentButtons.forEach(btn => btn.classList.remove('selected'));
            
            // é¸ä¸­ç•¶å‰å­¸ç”ŸæŒ‰éˆ•
            button.classList.add('selected');
            selectedStudent = student;
            
            // å•Ÿç”¨ç‰¹è³ªæŒ‰éˆ•
            enableTraitButtons();
            
            // æ¸…ç©ºå·²é¸ç‰¹è³ª
            selectedTraits.clear();
            updateSelectedTraitsDisplay();
            
            // é¡¯ç¤ºè©²å­¸ç”Ÿçš„è©•èªï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            const previewArea = document.getElementById('previewArea');
            previewArea.value = commentHistory[student] || '';
        }

        function enableTraitButtons() {
            const traitButtons = document.querySelectorAll('.trait-btn');
            traitButtons.forEach(button => {
                button.classList.add('enabled');
            });
        }

        function disableTraitButtons() {
            const traitButtons = document.querySelectorAll('.trait-btn');
            traitButtons.forEach(button => {
                button.classList.remove('enabled');
                button.classList.remove('selected');
            });
        }

        // æ–°å¢ï¼šå„²å­˜å’Œè¼‰å…¥å­¸ç”Ÿæ¸…å–®çš„å‡½æ•¸
        function saveStudentList() {
            const studentsText = document.getElementById('studentsInput').value;
            localStorage.setItem('studentList', studentsText);
        }

        function loadStudentList() {
            const savedList = localStorage.getItem('studentList');
            if (savedList) {
                document.getElementById('studentsInput').value = savedList;
            }
        }

        // æ–°å¢ï¼šæ›´æ–°å­¸ç”ŸæŒ‰éˆ•ç‹€æ…‹çš„å‡½æ•¸
        function updateStudentButtonStatus() {
            const buttons = document.querySelectorAll('.student-btn');
            buttons.forEach(button => {
                if (commentHistory[button.textContent]) {
                    button.classList.add('has-comment');
                } else {
                    button.classList.remove('has-comment');
                }
            });
        }

        // æ–°å¢ï¼šæ¸…é™¤è¨˜éŒ„æŒ‰éˆ•çš„è™•ç†å‡½æ•¸
        function clearCommentHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è©•èªè¨˜éŒ„å—ï¼Ÿ\nï¼ˆè‡ªè¨‚ç‰¹è³ªå°‡ä¿ç•™ï¼‰')) {
                commentHistory = {};
                document.getElementById('previewArea').value = '';
                updateStudentButtonStatus();
            }
        }

        // æ–°å¢ï¼šå„²å­˜å’Œè¼‰å…¥è‡ªè¨‚ç‰¹è³ªçš„å‡½æ•¸
        function saveCustomTraits() {
            localStorage.setItem('customTraits', JSON.stringify(customTraits));
        }

        function loadCustomTraits() {
            const saved = localStorage.getItem('customTraits');
            if (saved) {
                customTraits = JSON.parse(saved);
                traitData.traits['ä½¿ç”¨è€…å®¢è£½'] = customTraits;
                customTraitCount = customTraits.length;
            }
        }

        // æ–°å¢ï¼šæ¸…é™¤è‡ªè¨‚ç‰¹è³ªçš„å‡½æ•¸
        function clearCustomTraits() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è‡ªè¨‚ç‰¹è³ªå—ï¼Ÿ')) {
                customTraits = [];
                traitData.traits['ä½¿ç”¨è€…å®¢è£½'] = [];
                customTraitCount = 0;
                saveCustomTraits();
                updateTraits();
            }
        }

        // æ–°å¢ï¼šé‡ç½®ç‰¹è³ªæŒ‰éˆ•å‡½æ•¸
        function resetTraitButtons() {
            if (!selectedStudent) {
                alert('è«‹å…ˆé¸æ“‡å­¸ç”Ÿï¼');
                return;
            }
            
            const traitButtons = document.querySelectorAll('.trait-btn');
            traitButtons.forEach(button => {
                button.classList.remove('selected');
            });
            selectedTraits.clear();
            updateSelectedTraitsDisplay();
        }

        // æ–°å¢ï¼šæ¸…ç©ºå·²é¸ç‰¹è³ªå‡½æ•¸
        function clearSelectedTraits() {
            if (!selectedStudent) {
                alert('è«‹å…ˆé¸æ“‡å­¸ç”Ÿï¼');
                return;
            }
            
            selectedTraits.clear();
            updateTraits();
            updateSelectedTraitsDisplay();
        }

        function initializeStyleButtons() {
            const styleButtonsContainer = document.getElementById('styleButtons');
            styleData.forEach(style => {
                const button = document.createElement('button');
                button.className = 'style-btn';
                button.textContent = style.name;
                
                // æ·»åŠ æç¤ºæ¡†
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.innerHTML = `${style.description}<br><br>ä¾‹ï¼š${style.example}`;
                button.appendChild(tooltip);
                
                button.onclick = () => toggleStyle(style.name, button);
                styleButtonsContainer.appendChild(button);
            });
        }

        function toggleStyle(styleName, button) {
            if (selectedStyles.has(styleName)) {
                selectedStyles.delete(styleName);
                button.classList.remove('selected');
            } else {
                if (selectedStyles.size >= 2) {
                    alert('æœ€å¤šåªèƒ½é¸æ“‡å…©ç¨®é¢¨æ ¼ï¼');
                    return;
                }
                selectedStyles.add(styleName);
                button.classList.add('selected');
            }
        }

        function resetStyleButtons() {
            selectedStyles.clear();
            document.querySelectorAll('.style-btn').forEach(button => {
                button.classList.remove('selected');
            });
        }

        let currentWordLimit = 150;  // é è¨­ 150 å­—

        function setWordLimit(limit) {
            currentWordLimit = limit;
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.word-limit-btn').forEach(button => {
                button.classList.remove('selected');
                if (button.textContent === `${limit}å­—`) {
                    button.classList.add('selected');
                }
            });
        }
    </script>
</body>
</html> 