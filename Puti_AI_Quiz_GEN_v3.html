<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puti-AI測驗產生器</title>
    <style>
.header {
            text-align: center;
            padding: 20px;
            background-color: #4CAF50;
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: white;
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .header p {
            color: white;
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
        }        


* {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
        }

        .tab.active {
            border-bottom: 2px solid #4CAF50;
            color: #4CAF50;
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"], 
        textarea, 
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        .button:hover {
            background-color: #45a049;
        }

        .generated-questions {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .template-item {
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .template-actions {
            display: flex;
            gap: 10px;
        }

        .delete-btn {
            background-color: #ff4444;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .apply-btn {
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

const style = document.createElement('style');
style.textContent = `
.question {
    margin-bottom: 20px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.options {
    margin: 10px 0;
}

.options label {
    display: block;
    margin: 5px 0;
    cursor: default;
}

.options input[type="radio"] {
    margin-right: 5px;
}

.explanation {
    margin-top: 10px;
    color: #666;
}
`;
document.head.appendChild(style);
    </style>
</head>
<body>
<div class="header">
        <h1>Puti - AI測驗題產生器3.0</h1>
        <p>本工具內建免費的Gemini API，限制每分鐘最多 60 個請求，<br>如果使用熱烈而無法生成，請見諒，稍後或冷門時段再試。</p>
    </div>    

<div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="generation">出題</button>
            <button class="tab" data-tab="templates">出題範本</button>
        </div>

        <div id="generation" class="content active">
            <div class="form-group">
                <label for="topic">主題 *</label>
                <input type="text" id="topic" required>
            </div>

            <div class="form-group">
                <label for="text">主題文本</label>
                <textarea id="text"></textarea>
            </div>

            <div class="form-group">
                <label for="conditions">附加條件</label>
                <textarea id="conditions"></textarea>
            </div>

            <div class="form-group">
                <label for="grade">適用年級</label>
                <select id="grade">
                    <option value="">請選擇年級</option>
                </select>
            </div>

            <div class="form-group">
                <label for="questionCount">題數</label>
                <select id="questionCount">
                    <option value="">請選擇題數</option>
                </select>
            </div>

            <button id="generate" class="button">生成題目</button>
            <button id="saveTemplate" class="button">存成出題範本</button>
            <button id="exportText" class="button">匯出文字檔</button>
            <button id="exportCsv" class="button">匯出CSV檔</button>

            <div id="generatedQuestions" class="generated-questions"></div>
        </div>

        <div id="templates" class="content">
            <div id="templateList"></div>
        </div>
    </div>

    <script>
        const GEMINI_API_KEY = 'AIzaSyAwJ2XbI6B3w3x6wQy--3N4SnXpshBPU40';
let currentQuestions = [];

// 初始化
document.addEventListener('DOMContentLoaded', () => {
    initializeSelects();
    initializeTabs();
    loadTemplates();
    addEventListeners();
});

function initializeSelects() {
    const gradeSelect = document.getElementById('grade');
    const questionCountSelect = document.getElementById('questionCount');

    // 年級選項
    for (let i = 1; i <= 12; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `${i}年級`;
        gradeSelect.appendChild(option);
    }

    // 題數選項
    for (let i = 1; i <= 10; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `${i}題`;
        questionCountSelect.appendChild(option);
    }
}

function initializeTabs() {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            const contents = document.querySelectorAll('.content');
            contents.forEach(content => content.classList.remove('active'));
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });
}

function addEventListeners() {
    document.getElementById('generate').addEventListener('click', generateQuestions);
    document.getElementById('saveTemplate').addEventListener('click', saveTemplate);
    document.getElementById('exportText').addEventListener('click', exportText);
    document.getElementById('exportCsv').addEventListener('click', exportCsv);
}

async function generateQuestions() {
    const topic = document.getElementById('topic').value;
    if (!topic) {
        alert('請輸入主題');
        return;
    }

    const text = document.getElementById('text').value;
    const conditions = document.getElementById('conditions').value;
    const grade = document.getElementById('grade').value;
    const questionCount = document.getElementById('questionCount').value;

    const prompt = `你是一個教學經驗豐富的資深教師，也是一個評量命題專家。
請根據以下條件出${questionCount}題單選題：
主題：${topic}
${text ? `主題文本：${text}` : ''}
${conditions ? `附加條件：${conditions}` : ''}
${grade ? `適用年級：${grade}年級` : ''}

請依照以下格式輸出題目：
第1題
題目：（題目內容）
A. 選項內容
B. 選項內容
C. 選項內容
D. 選項內容
答案：（A/B/C/D）
解說：（解說內容）

第2題
...（依此類推）`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }]
            })
        });

        const data = await response.json();
        if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
            throw new Error('未收到有效的回應');
        }

        const generatedText = data.candidates[0].content.parts[0].text;
        currentQuestions = parseQuestions(generatedText);
        displayQuestions(currentQuestions);
    } catch (error) {
        console.error('Error:', error);
        alert('生成題目時發生錯誤: ' + error.message);
    }
}

function parseQuestions(text) {
    const questions = [];
    const questionBlocks = text.split(/第\d+題/).filter(block => block.trim());

    questionBlocks.forEach(block => {
        try {
            // 解析題目
            const questionMatch = block.match(/題目：(.*?)(?=A\.|\n)/s);
            const question = questionMatch ? questionMatch[1].trim() : '';

            // 解析選項
            const options = [];
            const optionsMatch = block.match(/[A-D]\.(.*?)(?=[A-D]\.|\n答案：)/gs);
            if (optionsMatch) {
                optionsMatch.forEach(opt => {
                    options.push(opt.replace(/[A-D]\./, '').trim());
                });
            }

            // 解析答案
            const answerMatch = block.match(/答案：([A-D])/);
            const answerLetter = answerMatch ? answerMatch[1] : '';
            const answer = answerLetter.charCodeAt(0) - 65; // 將A-D轉換為0-3

            // 解析解說
            const explanationMatch = block.match(/解說：(.*?)(?=第\d+題|$)/s);
            const explanation = explanationMatch ? explanationMatch[1].trim() : '';

            if (question && options.length === 4 && answer >= 0 && explanation) {
                questions.push({
                    question,
                    options,
                    answer,
                    explanation
                });
            }
        } catch (error) {
            console.error('解析題目時發生錯誤:', error);
        }
    });

    return questions;
}

function displayQuestions(questions) {
    const container = document.getElementById('generatedQuestions');
    container.innerHTML = questions.map((q, i) => `
        <div class="question">
            <div>${i + 1}. ${q.question}</div>
            <div class="options">
                ${q.options.map((opt, j) => `
                    <div>
                        <label>
                            <input type="radio" name="q${i}" value="${j}" disabled ${j === q.answer ? 'checked' : ''}>
                            ${String.fromCharCode(65 + j)}. ${opt}
                        </label>
                    </div>
                `).join('')}
            </div>
            <div class="explanation">解說：${q.explanation}</div>
        </div>
    `).join('');
}
function saveTemplate() {
    const template = {
        topic: document.getElementById('topic').value,
        text: document.getElementById('text').value,
        conditions: document.getElementById('conditions').value,
        grade: document.getElementById('grade').value,
        questionCount: document.getElementById('questionCount').value,
        timestamp: Date.now()
    };

    // 使用localStorage替代chrome.storage
    let templates = JSON.parse(localStorage.getItem('templates') || '[]');
    templates.push(template);
    localStorage.setItem('templates', JSON.stringify(templates));
    loadTemplates();
    alert('範本已儲存！');
}

function loadTemplates() {
    // 使用localStorage替代chrome.storage
    const templates = JSON.parse(localStorage.getItem('templates') || '[]');
    const container = document.getElementById('templateList');
    
    container.innerHTML = templates.map((template, index) => `
        <div class="template-item">
            <div class="template-info">
                <div>主題：${template.topic}</div>
                <div>年級：${template.grade}年級</div>
                <div>題數：${template.questionCount}題</div>
            </div>
            <div class="template-actions">
                <button class="apply-btn" onclick="applyTemplate(${index})">套用</button>
                <button class="delete-btn" onclick="deleteTemplate(${index})">刪除</button>
            </div>
        </div>
    `).join('');
}

function applyTemplate(index) {
    const templates = JSON.parse(localStorage.getItem('templates') || '[]');
    const template = templates[index];
    document.getElementById('topic').value = template.topic;
    document.getElementById('text').value = template.text;
    document.getElementById('conditions').value = template.conditions;
    document.getElementById('grade').value = template.grade;
    document.getElementById('questionCount').value = template.questionCount;
    
    // 切換到出題頁面
    document.querySelector('[data-tab="generation"]').click();
}

function deleteTemplate(index) {
    let templates = JSON.parse(localStorage.getItem('templates') || '[]');
    templates.splice(index, 1);
    localStorage.setItem('templates', JSON.stringify(templates));
    loadTemplates();
}

function exportText() {
    if (!currentQuestions.length) {
        alert('請先生成題目');
        return;
    }

    let content = '題目：\n\n';
    currentQuestions.forEach((q, i) => {
        content += `${i + 1}. ${q.question}\n`;
        q.options.forEach((opt, j) => {
            content += `${String.fromCharCode(65 + j)}. ${opt}\n`;
        });
        content += '\n';
    });

    content += '\n答案與解說：\n\n';
    currentQuestions.forEach((q, i) => {
        content += `${i + 1}. 答案：${String.fromCharCode(65 + q.answer)}\n`;
        content += `   解說：${q.explanation}\n\n`;
    });

    downloadFile('questions.txt', content);
}

function exportCsv() {
    if (!currentQuestions.length) {
        alert('請先生成題目');
        return;
    }

    let csv = '\uFEFF'; // 添加 BOM
    
    // 添加標題行
    csv += '題目,選項A,選項B,選項C,選項D,正確答案,解說\n';

    // 添加題目資料
    currentQuestions.forEach(q => {
        const row = [
            q.question,
            q.options[0],
            q.options[1],
            q.options[2],
            q.options[3],
            String.fromCharCode(65 + q.answer), // 將數字轉換為A/B/C/D
            q.explanation
        ];
        
        // 處理每個欄位，確保特殊字元被正確處理
        const processedRow = row.map(field => {
            // 如果欄位包含逗號、換行或引號，就用引號包住並將引號轉換為兩個引號
            if (field.includes(',') || field.includes('\n') || field.includes('"')) {
                return `"${field.replace(/"/g, '""')}"`;
            }
            return field;
        });
        
        csv += processedRow.join(',') + '\n';
    });

    downloadFile('questions.csv', csv);
}

function downloadFile(filename, content) {
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
    </script>
</body>
</html>